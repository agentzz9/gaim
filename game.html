<html><head><style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style></head><body></body>
<script src="./ComponentsAndUtils.js"></script>
<script type="text/javascript">
var PLAYER, goal;
var speed;
var dist = 0;
var otherCars = [];
var tempCar;
var leftWall, rightWall;
var sideline1, sideline2;
var roadLines = [];
var speedText;
var startButton;
var speedValueText;
var spectatorImage;
var spectatorMessage;

var gameArea = {
	canvas: document.createElement("canvas"),
    prestart : function() {
        this.canvas.width = 1320;
        this.canvas.height = 600;
        this.canvas.style = "background-color:#404142";
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        window.addEventListener('mousedown', function (e) {
            gameArea.x = e.pageX;
            gameArea.y = e.pageY;
            
        })
        window.addEventListener('mouseup', function (e) {
            gameArea.x = false;
            gameArea.y = false;
        })
        this.interval = setInterval(updatePreGameArea, 20);
    },
    start : function() {
        this.canvas.width = 1320;
        this.canvas.height = 600;
        this.canvas.style = "background-color:#404142";
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        window.addEventListener('keydown', function (e) {
                e.preventDefault();//prevent scroll of window :(
                gameArea.keys = (gameArea.keys || []);
                gameArea.keys[e.keyCode] = true;
            })
        window.addEventListener('keyup', function (e) {
            gameArea.keys[e.keyCode] = false; 
        })
        this.interval = setInterval(updateGameArea, 20);

    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
    },
    stop : function() {
        clearInterval(this.interval);
    }
}

function everyinterval(n) {
    if ((gameArea.frameNo / n) % 1 == 0) {return true;}
    return false;
}

function updatePreGameArea(){

    
    gameArea.clear();
    gameArea.frameNo += 1;

    if(gameArea.x && gameArea.y){
        //debugger;
        if( startButton.isClicked() ){
            gameArea.stop();
            startGame();
        }
    }
    startButton.newPos();
    startButton.update();

}
function updateGameArea(){

	/*detect collisions, win/lose conditions, parse inputs, 
		trigger random obstacles ?, set speeds of components
       */
    if(everyinterval(500)){
   /* 
        tempCar = new OtherCarComponent(50, 75, "blue", gameArea.canvas.width/2,
            -25);
*/
        var randXonRoadVar = randXonRoad();
        tempCar = new OtherCarComponent(50, 75, "blue", randXonRoadVar, 500);
      
        tempCar.speedY = -1* randSpeed();
        tempCar.speedYInit = tempCar.speedY;
//       tempCar.speedYBias = -1;
        otherCars.push(tempCar);
        //console.log(otherCars[otherCars.length-1].speedY+" push Event "+otherCars.length); 
    }
    /*
    for(i=0; i<roadLines.length; i+=1){
        if(roadLines[i].y >= gameArea.canvas.height){
            roadLines.push(
                     new Component(15, 100, "white", (gameArea.canvas.width*.5)-6,
            0)

                    );
            roadLines.splice(0, 1); 
            break;
        }
    }*/

    /*for(i=0; i<otherCars.length; i+=1){
        console.log(otherCars[i].y);
    }*/
    //console.log(otherCars.length);
    
    if (gameArea.keys && gameArea.keys[37]) {moveLeft(); }
    if (gameArea.keys && gameArea.keys[39]) {moveRight(); }
    if (gameArea.keys && !gameArea.keys[37] && !gameArea.keys[39]){
        moveLeftRight();
    }
    if (gameArea.keys && gameArea.keys[38]) {
        accelerateUp();
    }
    if(gameArea.keys && !gameArea.keys[38]){
        accelerateDown();
    }
    if (gameArea.keys && gameArea.keys[40]) {
        accelerateDownBraking();
    }

    gameArea.clear();
    gameArea.frameNo += 1;
	//console.log(gameArea.frameNo);
	/*
	update components.redraw frame
	*/
    roadLine1.newPos();
    roadLine1.update();
    speed = roadLine1.speedY;//console.log(speed);
    speedValueText.text = ""+speed;
    dist += speed;
    //console.log(dist);
   
    
    leftWall.newPos();
    leftWall.update();
    rightWall.newPos();
    rightWall.update();
    sideline1.newPos();
    sideline1.update();
    sideline2.newPos();
    sideline2.update();
    speedText.newPos();
    speedText.update();
    speedValueText.newPos();
    speedValueText.update();
    spectatorImage.newPos();
    spectatorImage.update();
    spectatorMessage.newPos();
    spectatorMessage.update();
    for(i=0; i<otherCars.length; i+=1){
        otherCars[i].speedY = speed+otherCars[i].speedYInit;
        otherCars[i].newPos();
        otherCars[i].update();
    } 
    PLAYER.newPos();
    PLAYER.update();

}
function moveLeft(){
    PLAYER.speedX = -10;
}
function moveRight(){
    PLAYER.speedX = +10;
}
function moveLeftRight(){
    PLAYER.speedX = 0;
}
/*function moveUp(){
    for(i=0; i<roadLines.length; i+=1){
        roadLines[i].speedY  = +1; 
    }
    roadLine1.speedY = +1;
    for(i=0; i<otherCars.length; i+=1){
        otherCars[i].speedY += 1;
    }
}
function moveUpDown(){
    for(i=0; i<roadLines.length; i+=1){
        roadLines[i].speedY  = 0; 
    }
    roadLine1.speedY = 0;
    for(i=0; i<otherCars.length; i+=1){
        //otherCars[i].speedY = 5; 
    }
    function moveDown(){
        for(i=0; i<roadLines.length; i+=1){
            roadLines[i].speedY = -1;
        }
        roadLine1.speedY = -1;
    }
}*/
        
function accelerateUp(){
        document.getElementById("speed").innerHTML =
        Math.round(roadLine1.speedY);
        document.getElementById("speed2").innerHTML
        ="  "+Math.cbrt(1/Math.max(roadLine1.speedY,1)); 
        var cacheRoadLine1Speed = roadLine1.speedY;
        roadLine1.speedY = Math.min(
            (roadLine1.speedY +
                Math.cbrt(1/(10000*Math.max(roadLine1.speedY,1))))
            ,50);

}
function accelerateDown(){

    document.getElementById("speed").innerHTML =
    Math.round(roadLine1.speedY);
    //document.getElementById("speed2").innerHTML
     //    ="  "+Math.cbrt(1/Math.max(roadLine1.speedY,1));
     var cacheRoadLine1Speed = roadLine1.speedY;
     roadLine1.speedY = Math.max(
        (roadLine1.speedY -
            Math.cbrt(1/(10000*Math.max(roadLine1.speedY,1))))
        ,0);
}
function accelerateDownBraking(){

    document.getElementById("speed").innerHTML =
    Math.round(roadLine1.speedY);
    //document.getElementById("speed2").innerHTML
    //     ="  "+Math.cbrt(1/Math.max(roadLine1.speedY,1));
    var cacheRoadLine1Speed = roadLine1.speedY;

    roadLine1.speedY = Math.max(
        (roadLine1.speedY -
            Math.cbrt(1/(100*Math.max(roadLine1.speedY,1))))
        ,0);

}
function preStartGame(){

    startButton = new Component("30px", "Consolas", "green", 200, 200, "text");
    startButton.text = "start";
    gameArea.prestart();
}
function startGame(){
	
	//initialize objects,
    PLAYER  = new PlayerCarComponent(216/3, 490/3, "red", gameArea.canvas.width/2 ,
        gameArea.canvas.height*0.70);

    leftWall = new Component(gameArea.canvas.width*.33, 2000, "green", 0, -10);

    rightWall = new Component(gameArea.canvas.width*.33, 2000, "green",
        gameArea.canvas.width*.67, -10);
    sideline1 = new Component(15, 3000, "white", (gameArea.canvas.width*.33)+6,
        -10);
    sideline2 = new Component(15, 3000, "white",
        (gameArea.canvas.width*.67)-21,-10);
    roadLine1 = new RoadlineComponent(15, 100, "white",
        (gameArea.canvas.width*.5)-6,-100);
    speedText = new Component("30px", "Consolas", "blue", gameArea.canvas.width*.70, 30, "text");
    speedText.text = "Speed :";
    speedValueText = new SpeedValueComponent("30px", "Consolas", "blue", gameArea.canvas.width*.80, 30, "text", 20);
    speedValueText.text = ""+speed; 
    spectatorImage = new Component(200,
            200,"spectatorimage",gameArea.canvas.width*.10, 40,"image"  );
    spectatorMessage = new Component("25px", "Consolas", "black",
            gameArea.canvas.width*.025,
            20+spectatorImage.y+spectatorImage.width,"text");
    spectatorMessage.text = "";
    gameArea.start();

}
function stopGame(){
	gameArea.stop();
}

</script>
<button onclick="preStartGame()">prestartgame</button>
<button onclick="startGame()">startgame</button>
<button onclick="stopGame()">stopgame</button>
<span id="speed"></span><span id="speed2"></span>
<img hidden id="car" src="carimage.png"/>
<img hidden id="speedoimage" src="masdash.png"/>
<img hidden id="spectatorimage" src="spectatorimage.png"/>

<!-- <img hidden id="uparrow" src="uparrow.png"/>
<img hidden id="downarrow" src="downarrow.png"/>
<img hidden id="leftarrow" src="leftarrow.png"/>
<img hidden id="rightarrow" src="rightarrow.png"/> -->


</html>
